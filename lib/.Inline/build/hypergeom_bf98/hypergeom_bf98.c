/*
 * This file was generated automatically by ExtUtils::ParseXS version 2.18_02 from the
 * contents of hypergeom_bf98.xs. Do not edit this file, edit hypergeom_bf98.xs instead.
 *
 *	ANY CHANGES MADE HERE WILL BE LOST! 
 *
 */

#line 1 "hypergeom_bf98.xs"
#include "EXTERN.h"
#include "perl.h"
#include "XSUB.h"
#include "INLINE.h"
/** Begin of the C Code **/

#define MIN(x,y) ((x<y)?x:y)
#define MAX(x,y) ((x>y)?x:y)

double gammaln(double x) {
    double y,tmp,ser,
	cof[6]={76.18009173,-86.50532033,24.01409822,
		-1.231739516,0.120858003e-2,-0.536382e-5};
    int    i;
    
    if (x==0.0 || x==1.0)
	return 0.0;
    
    y=x-1.0;
    tmp=y+5.5;
    tmp-=(y+0.5)*log(tmp);
    ser=1.0;
    for (i=0;i<=5;i++) {
	y+=1.0;
	ser+=cof[i]/y;
    }
    
    return log(x) +(log(2.50662827465*ser)-tmp);
}

double choose(int A, int B){

    double choose_res = gammaln(A) - (gammaln(B)+gammaln(A-B));

//    printf ("(%d %d) = %.5f\n",A,B,choose_res);
    return choose_res;
}

double hypergeom_c(int N, int M, int k, int x)
{
    double prob = 0;  /* Final probability */
    double lprob; /* ln(prob) */
    double pvalue = 0;
    double i;     /* Counter */


    lprob = choose(M,x)+choose((N-M),(k-x))-choose(N,k);
    prob = exp(lprob);

//    printf ("\nprob = %.10f\n",prob);
    
    for (i=x; i<=MIN(k,M); i++){
	lprob = choose(M,i)+choose((N-M),(k-i))-choose(N,k);
	pvalue += exp(lprob);
    }
//    printf ("pvalue = %.10f\n",pvalue);

    return pvalue;
}

/** End of C Code **/

#ifndef PERL_UNUSED_VAR
#  define PERL_UNUSED_VAR(var) if (0) var = var
#endif

#line 77 "hypergeom_bf98.c"

XS(XS_hypergeom_gammaln); /* prototype to pass -Wmissing-prototypes */
XS(XS_hypergeom_gammaln)
{
#ifdef dVAR
    dVAR; dXSARGS;
#else
    dXSARGS;
#endif
    if (items != 1)
       Perl_croak(aTHX_ "Usage: %s(%s)", "hypergeom::gammaln", "x");
    PERL_UNUSED_VAR(cv); /* -W */
    {
	double	x = (double)SvNV(ST(0));
	double	RETVAL;
	dXSTARG;

	RETVAL = gammaln(x);
	XSprePUSH; PUSHn((double)RETVAL);
    }
    XSRETURN(1);
}


XS(XS_hypergeom_choose); /* prototype to pass -Wmissing-prototypes */
XS(XS_hypergeom_choose)
{
#ifdef dVAR
    dVAR; dXSARGS;
#else
    dXSARGS;
#endif
    if (items != 2)
       Perl_croak(aTHX_ "Usage: %s(%s)", "hypergeom::choose", "A, B");
    PERL_UNUSED_VAR(cv); /* -W */
    {
	int	A = (int)SvIV(ST(0));
	int	B = (int)SvIV(ST(1));
	double	RETVAL;
	dXSTARG;

	RETVAL = choose(A, B);
	XSprePUSH; PUSHn((double)RETVAL);
    }
    XSRETURN(1);
}


XS(XS_hypergeom_hypergeom_c); /* prototype to pass -Wmissing-prototypes */
XS(XS_hypergeom_hypergeom_c)
{
#ifdef dVAR
    dVAR; dXSARGS;
#else
    dXSARGS;
#endif
    if (items != 4)
       Perl_croak(aTHX_ "Usage: %s(%s)", "hypergeom::hypergeom_c", "N, M, k, x");
    PERL_UNUSED_VAR(cv); /* -W */
    {
	int	N = (int)SvIV(ST(0));
	int	M = (int)SvIV(ST(1));
	int	k = (int)SvIV(ST(2));
	int	x = (int)SvIV(ST(3));
	double	RETVAL;
	dXSTARG;

	RETVAL = hypergeom_c(N, M, k, x);
	XSprePUSH; PUSHn((double)RETVAL);
    }
    XSRETURN(1);
}

#ifdef __cplusplus
extern "C"
#endif
XS(boot_hypergeom_bf98); /* prototype to pass -Wmissing-prototypes */
XS(boot_hypergeom_bf98)
{
#ifdef dVAR
    dVAR; dXSARGS;
#else
    dXSARGS;
#endif
    char* file = __FILE__;

    PERL_UNUSED_VAR(cv); /* -W */
    PERL_UNUSED_VAR(items); /* -W */
    XS_VERSION_BOOTCHECK ;

        newXS("hypergeom::gammaln", XS_hypergeom_gammaln, file);
        newXS("hypergeom::choose", XS_hypergeom_choose, file);
        newXS("hypergeom::hypergeom_c", XS_hypergeom_hypergeom_c, file);
    if (PL_unitcheckav)
         call_list(PL_scopestack_ix, PL_unitcheckav);
    XSRETURN_YES;
}

